/*! Pilot 1.2.0 - MIT | git://github.com/rubaxa/Pilot.git */
(function(t,e){"use strict";function i(t){d.test(t)||(t="/"==t.charAt(0)?"//"+p.hostname+t:p.pathname.substr(0,p.pathname.lastIndexOf("/")+1)+t,t="//"==t.substr(0,2)?p.protocol+t:p.hostname+t,d.test(t)||(t=p.protocol+"//"+t));var e=(t.split("?")[1]||"").replace(/#.*/,""),i=r(e),n=t.match(d)[0].length+3,s=t.substr(t.indexOf("/",n)).replace(/\?.*/,""),o=this;e&&(e="?"+e),o.url=t,o.href=t,o.query=i,o.search=e,o.path=s,o.pathname=s,o.hash=t.replace(/^[^#]+#/,""),o.params={}}function n(t,e,i){if(t){var n=0,s=t.length;if(n in t&&s!==c)for(;s>n;n++)e.call(i,t[n],n,t);else for(n in t)t.hasOwnProperty(n)&&e.call(i,t[n],n,t)}}function s(t,e){var i,n=arguments,s=1,r=n.length;for(t=t||{};r>s;s++)if(e=n[s],e&&/object|function/.test(typeof e))for(i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);return t}function r(t){var e={};if("string"==typeof t)for(var i,n,s,r=t.split("&"),o=0,h=r.length;h>o;o++){i=r[o].split("="),n=i[0],s=void 0===i[1]?"":i[1];try{s=decodeURIComponent(s)}catch(a){s=unescape(s)}n.length>0&&(void 0===e[n]?e[n]=s:e[n]instanceof Array?e[n].push(s):e[n]=[e[n],s])}return e}function o(t,e,i,n){return t instanceof RegExp?t:(_(t)&&(t="("+t.join("|")+")"),t=t.concat(n?"":"/?").replace(/(\/\(|\(\/)/g,"(?:/").replace(/(\/)?(\.)?:(\w+)(?:(\([^?].*?\)))?(\?)?(\*)?/g,function(t,i,n,s,r,o,h){return e.push({name:s,optional:!!o}),i=i||"",""+(o?"":i)+"(?:"+(o?i:"")+(n||"")+(r||n&&"([^/.]+?)"||"([^/]+?)")+")"+(o||"")+(h?"(/*)?":"")}).replace(/([\/.])/g,"\\$1").replace(/\*/g,"(.*)"),RegExp("^"+t+"$",i?"":"i"))}function h(t,e,i,n){if(i){var s,r,o,h=1,a=e.exec(t);if(!a)return!1;for(s=a.length;s>h;++h)r=i[h-1],o="string"==typeof a[h]?decodeURIComponent(a[h]):a[h],r?n[r.name]=o:n.push(o);return!0}return e.test(t)}var a=0,u=function(){},c=void 0,l=t.history,f=t.document,p=t.location,d=/^(https?|file)/i,g=[].slice,m={}.toString,v=function(t,e){var i=g.call(arguments,2);return e.bind?e.bind.apply(e,[t].concat(i)):function(){return e.apply(t,i.concat(g(arguments)))}},_=e.isArray,y=function(t){var e=function(){if(e.fn.singleton){var t=e.__inst__;if(t)return t;e.__inst__=this}this.cid=this.uniqId=++a,this.__lego.apply(this,arguments)};return e.fn=e.prototype=t||{},e.fn.__self=e.fn.constructor=e,e.extend=function(t){var i=y();return u.prototype=this.fn,i.prototype=new u,s(i,this),s(i.fn=i.prototype,t),i.fn.__fn=i.fn.__super__=this.fn,i.fn.__self=i.fn.__self__=e.fn.constructor=i,i},e},x=y({__lego:function(){var t=e(this);n({on:"bind",off:"unbind",fire:"triggerHandler"},function(e,i){this[i]=function(){return t[e].apply(t,arguments),this}},this)},emit:function(t,i){var n,s=("on-"+t).replace(/-(.)/g,function(t,e){return e.toUpperCase()}),r=e.Event(t.replace(/-/g,""));return r.target=this,(this[s]===c||this[s].apply(this,[r].concat(i))!==!1)&&(r.isImmediatePropagationStopped()||(n=this.fire(r,i))),n}}),R=x.extend({__lego:function(i){x.fn.__lego.call(this),s(this,{el:null,selector:"a[href],[data-nav]",path:"/",production:t.Pilot&&t.Pilot.production,useHistory:!1},i),this.items=[],this.itemsIdx={},this.request=this.referrer=R.parseURL(R.getLocation()),this.history=[],this.historyIdx=0,i&&(i.useHistory&&e(t).bind("popstate hashchange",v(this,function(){this.nav(R.getLocation())})),i.el&&e(i.el).delegate(i.selector,"click",v(this,function(t){this.nav(t.currentTarget.getAttribute("data-nav")||t.currentTarget.getAttribute("href")),t.preventDefault()}))),this.on("error",v(this,function(t,e){this.error(e.message+" at "+e.line+"line in "+(e.file||"")),this.log(e.stack)})),this.init()},init:function(){},route:function(t,e,i,n,s){var r=this.addRoute(t,e,i,n,s);return s?r:this},addRoute:function(t,i,n,s,r){if(/string|regexp/i.test(m.call(i))||(s=n,n=i,i=t,t=c),n&&!n.fn){var h=n;n=b.extend("function"!=typeof h?h:{init:function(){this.on("routestart routechange"+(s===!0?" routeend":""),h)}})}"regexp"!==e.type(i)&&(i=(this.path+("."==i?"":i)).replace(/\/\//,"/"));var a,u=[],l=this;return r&&(l=new R({path:i}),l.items=this.items,l.itemsIdx=this.itemsIdx,l.parentRouter=this,i+="*"),n&&(a=this.items.push({id:t,path:i,keys:u,regexp:o(i,u),unit:n||R.View,options:s}),t&&(this.itemsIdx[t]=a-1)),r?l:a},removeRoute:function(t){t=this.itemsIdx[t]||t,this.items.splice(t,1)},createGroup:function(t,e,i,n){return this.route(t,e,i,n,!0)},closeGroup:function(){return this.parentRouter||this},_getUnits:function(t,e){var i=[];return n(e,function(e){var n=e.unit,r=[];h(t.path,e.regexp,e.keys,r)&&(n.__self===c&&(e.unit=n=new n(s({id:e.id,router:this,inited:!1},e.options))),n.requestParams=r,i.push(n))},this),i},_loadUnits:function(t,i){var s,r,o=[],h=function(t){r.push(t)};for(r=i.concat();s=r.shift();)if(s&&s.isActive(i)){if(n(s.units,h),t.params=s.requestParams,s.loadData)try{s=s.loadData(t,this._navByHistory)}catch(a){return a.name="loadData",this.emit("error",a),e.Deferred().reject()}_(s)?r.push.apply(r,s):s&&o.push(s),delete t.params}return e.when.apply(e,o)},_doRouteUnits:function(t,i){n(i,function(i){var n=i.unit,s=!0,r=[],o=t.clone();if(o.params=r,n.request=o,h(o.path,i.regexp,i.keys,r)&&n.isActive(this.activeUnits)){if(n.inited!==!0&&n.__init(),n.active!==!0){s=!1,n.active=!0;try{n.emit("route-start",o)}catch(a){a.name="routestart",this.emit("error",a,o)}}try{n.emit("route",o)}catch(a){a.name="route",this.emit("error",a,o),this.emit("routeerror",a,o)}if(s)try{n.emit("route-change",o)}catch(a){a.name="routechange",this.emit("error",a,o)}}else if(n.active===!0&&!~e.inArray(n,this.activeUnits)){n.active=!1;try{n.emit("route-end",o)}catch(a){a.name="routeend",this.emit("geterror",a,o)}}},this)},_doRouteDone:function(t){if(this.activeRequest===t){if(this.request.url!=t.url&&(this.referrer=this.request,this.useHistory&&R.setLocation(t)),this.request=t,this._navByHistory||(this.history=this.history.slice(0,this.historyIdx+1),this.historyIdx=this.history.push(t.url)-1),this.items.length)try{this._doRouteUnits(t,this.items)}catch(e){e.name="route",this.emit("error",e)}var i=new Date-this.__ts;this.emit("route",[t,i]),this.log("Pilot.nav: "+i+"ms ("+t.path+t.search+")")}},_doRouteFail:function(t){this.activeRequest===t&&(this.activeRequest=null,this.emit("route-fail",t))},log:function(e){!this.production&&t.console&&console.log(e)},error:function(e){this.production||(t.console&&console.error?console.error(e):this.log(e))},get:function(t){var e=this.getItem(t);return e&&e.unit},getItem:function(t){return this.items[this.itemsIdx[t]]},getUrl:function(t,e,i){var n,r,o=this.getItem(t),h=0;return o&&(e=s({},e,i),n=o.keys,r=o.path.replace(/:(\w+)\??(\/?)/g,function(t,i,s,r){return i=n[h++],r=i&&e[i.name],r?r+(s||""):"("+t+")"}).replace(/\(.*?:[^)]+\)+\??/g,"").replace(/\(|\)\??/g,"").replace(/\/+/g,"/")),r},start:function(t){this.started||this._nav(t||this.request,!1,!0)},_nav:function(t,i,n){var s=e.Deferred(),r=R.parseURL(t.href||t.url||t);if(this.started=!0,this._navByHistory=!!i,n||!this.activeRequest||this.activeRequest.url!=r.url){this.__ts=+new Date,this.emit("before-route",[r,this.__ts]);var o=this._getUnits(r,this.items);r.referrer=this.request.url,this.activeUnits=o,this.activeRequest=r,o.length?this._loadUnits(r,o).done(v(this,this._doRouteDone,r)).fail(v(this,this._doRouteFail,r)).then(s.resolve,s.reject):(this._doRouteDone(r),this.emit("404",r),s.reject())}else s.resolve();return s.promise()},nav:function(t,i,n){return e.isFunction(i)&&(n=i,i=!1),this._nav(t,!1,i).then(n,n)},go:function(t,i){var n=this.getUrl(t,i);return n?this.nav(n):e.Deferred().reject().promise()},hasBack:function(){return this.historyIdx>0},back:function(){return this.hasBack()?this._nav(this.history[--this.historyIdx],!0):e.Deferred().resolve()},hasForward:function(){return!!this.history[this.historyIdx+1]},forward:function(){return this.hasForward()?this._nav(this.history[++this.historyIdx],!0):e.Deferred().resolve}});R.parseURL=function(t){return new i(t)},i.fn=i.prototype={constructor:i,clone:function(){return new i(this.url)}},R.setLocation=function(t){R.pushState&&l.pushState?l.pushState(null,f.title,t.url):p.hash="#!"+t.path+t.search},R.getLocation=function(){var t=""+p;return R.pushState||(t=t.split(/#!?/).pop()),R.parseURL(t).path};var b=x.extend({data:{},boundAll:[],__lego:function(t){x.fn.__lego.call(this),s(this,t),n(this.boundAll,function(t){this[t]=this.bound(t)},this),this.inited!==!1&&this.__init()},__init:function(){this.inited=!0,this.emit("beforeInit"),this.init(),this.emit("init")},_exception:function(t,e){throw"["+this.uniqId+"."+t+"]: "+e},isActive:function(){return!0},bound:function(t){return"string"==typeof t&&(this[t]===c&&this._exception("bound",t+" -- method not found"),t=this[t]),v(this,t)},init:u,loadData:u,destroy:u,getUrl:function(t,e,i){return this.router.getUrl(t,e,i)},setData:function(t,e){return e?s(this.data,t):this.data=t,this},getData:function(){return this.data}}),w=b.extend({el:null,$el:e(),tag:null,tagName:null,className:"",parentNode:null,template:null,events:{},__init:function(){if(this.inited=!0,this.el)this.setElement(e(this.el,this.parentNode));else if(this.tagName||this.tag){var t=this.tagName,i=this.parentNode,n=this.className;this.tag&&(t=this.tag.match(/^(#[^\s]+)?\s*([^\.]+)\.?([^$]+)?/),t[1]&&(i=t[1]),t[3]&&(n=t[3].split(".").join(" ")),t=t[2]),this.el=f.createElement(t),this.$el=e(this.el),n&&this.$el.addClass(n),i&&(e.isReady?this.$el.appendTo(i):e(this.bound(function(){this.$el.appendTo(i)})))}else this.$el[0]=c,this.$el.length=0;this.on("routestart.view routeend.view",this.bound(function(t){this.toggleView("routeend"!=t.type)})),b.fn.__init.call(this)},toggleView:function(t){this.$el&&this.$el.css("display",t?"":"none")},setElement:function(t){return this.undelegateEvents(),t?(this.$el=e(t),this.delegateEvents()):(this.$el[0]=c,this.$el.length=0),this.el=this.$el[0],this},delegateEvents:function(t){return this.undelegateEvents(),n(t||this.events,function(t,e){e=e.match(/^([^\s]+)\s+(.+)/),this.$el.delegate(e[2],e[1]+".delegateEvents"+this.cid,this.bound(t))},this),this},undelegateEvents:function(){return this.$el&&this.$el.unbind(".delegateEvents"+this.cid),this},$:function(t){var i=this.$el;return void 0!==t&&(i="string"==typeof t?i.find(t):e(t)),i},getHtml:function(t){return t=t?s({},this.getData(),t):this.getData(),this.template(t)},render:function(){var t=this.getHtml();"string"==typeof t&&(this.emit("before-render"),this.$el.empty().each(function(){this.innerHTML=t}),this.emit("render"))}});R.utils={each:n,extend:s,qs:{parse:r,stringify:e.param}},R.Route=b,R.View=w,R.Class=y,R.Emitter=x,R.Request=i,R.version="1.2.0",t.Pilot=R,"function"==typeof define&&define.amd&&define("Pilot",[],function(){return R})})(window,jQuery);