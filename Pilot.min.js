/*! Pilot 1.3 - MIT | git://github.com/rubaxa/Pilot.git */
(function(t){"use strict";function e(t){d.test(t)||(t="/"==t.charAt(0)?"//"+p.hostname+t:p.pathname.substr(0,p.pathname.lastIndexOf("/")+1)+t,t="//"==t.substr(0,2)?p.protocol+t:p.hostname+t,d.test(t)||(t=p.protocol+"//"+t)),t=t.substr(0,7)+t.substr(7).replace(/\/+/g,"/");var e=(t.split("?")[1]||"").replace(/#.*/,""),i=s(e),n=t.match(d)[0].length+3,r=t.substr(t.indexOf("/",n)).replace(/\?.*/,""),o=this;e&&(e="?"+e),o.url=t,o.href=t,o.query=i,o.search=e,o.path=r,o.pathname=r,o.hash=t.replace(/^[^#]+#/,""),o.params={}}function i(t,e,i){if(t){var n=0,s=t.length;if(n in t&&s!==u)for(;s>n;n++)e.call(i,t[n],n,t);else for(n in t)t.hasOwnProperty(n)&&e.call(i,t[n],n,t)}}function n(t,e){var i,n=arguments,s=1,r=n.length;for(t=t||{};r>s;s++)if(e=n[s],e&&/object|function/.test(typeof e))for(i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);return t}function s(t){var e={};if("string"==typeof t)for(var i,n,s,r=t.split("&"),o=0,a=r.length;a>o;o++){i=r[o].split("="),n=i[0],s=void 0===i[1]?"":i[1];try{s=decodeURIComponent(s)}catch(h){s=unescape(s)}n.length>0&&(void 0===e[n]?e[n]=s:e[n]instanceof Array?e[n].push(s):e[n]=[e[n],s])}return e}function r(t,e,i,n){return t instanceof RegExp?t:(_(t)&&(t="("+t.join("|")+")"),t=t.concat(n?"":"/?").replace(/(\/\(|\(\/)/g,"(?:/").replace(/(\/)?(\.)?:(\w+)(?:(\([^?].*?\)))?(\?)?(\*)?/g,function(t,i,n,s,r,o,a){return e.push({name:s,optional:!!o}),i=i||"",""+(o?"":i)+"(?:"+(o?i:"")+(n||"")+(r||n&&"([^/.]+?)"||"([^/]+?)")+")"+(o||"")+(a?"(/*)?":"")}).replace(/([\/.])/g,"\\$1").replace(/\*/g,"(.*)"),RegExp("^"+t+"$",i?"":"i"))}function o(t,e,i,n){if(i){var s,r,o,a=1,h=e.exec(t);if(!h)return!1;for(s=h.length;s>a;++a)r=i[a-1],o="string"==typeof h[a]?decodeURIComponent(h[a]):h[a],r?n[r.name]=o:n.push(o);return!0}return e.test(t)}var a=0,h=function(){},u=void 0,c=t.jQuery||t.Zepto||t.ender||h,l=t.history,f=t.document,p=t.location,d=/^(https?|file)/i,g=[].slice,m={}.toString,v=function(t,e){var i=g.call(arguments,2);return e.bind?e.bind.apply(e,[t].concat(i)):function(){return e.apply(t,i.concat(g.call(arguments)))}},_=Array.isArray||c.isArray,y=function(t,e){var i=t.accessPermission,n=b.access[i];return void 0===i||(n?n(e):!1)},x=function(t){var e=function(){if(e.fn.singleton){if(e.__inst__)return e.__inst__;e.__inst__=this}this.cid=this.uniqId=++a,this.__lego.apply(this,arguments)};return e.fn=e.prototype=t||{},e.fn.__self=e.fn.constructor=e,e.extend=function(t){var i=x();return h.prototype=this.fn,i.prototype=new h,n(i,this),n(i.fn=i.prototype,t),i.fn.__fn=i.fn.__super__=this.fn,i.fn.__self=i.fn.__self__=e.fn.constructor=i,i},e},R=x({__lego:function(){var t=c(this);i({on:"bind",off:"unbind",fire:"triggerHandler"},function(e,i){this[i]=function(){return t[e].apply(t,arguments),this}},this)},emit:function(t,e){var i,n=("on-"+t).replace(/-(.)/g,function(t,e){return e.toUpperCase()}),s=c.Event(t.replace(/-/g,""));return s.target=this,(this[n]===u||this[n].apply(this,[s].concat(e))!==!1)&&(s.isImmediatePropagationStopped()||(i=this.fire(s,e))),i}}),b=R.extend({__lego:function(e){R.fn.__lego.call(this),this.options=e=n({el:null,selector:"a[href],[data-nav]",basePath:"/",production:t.Pilot&&t.Pilot.production,useHistory:!1},e),this.items=[],this.itemsIdx={},this.request=this.referrer=b.parseURL(b.getLocation()),this.history=[],this.historyIdx=0,e.useHistory&&c(t).bind("popstate hashchange",v(this,function(){this.nav(b.getLocation())})),e.el&&c(e.el).delegate(e.selector,"click",v(this,function(t){this.nav(b.getLocation(t.currentTarget.getAttribute("data-nav")||t.currentTarget.getAttribute("href"))),t.preventDefault()})),this.on("error",v(this,function(t,e){this.error(e.message+" at "+e.line+"line in "+(e.file||"")),this.log(e.stack)})),this.init()},init:function(){},route:function(t,e,i,n,s){var r=this.addRoute(t,e,i,n,s);return s?r:this},addRoute:function(t,e,i,n,s){if(/string|regexp/i.test(m.call(e))||(n=i,i=e,e=t,t=u),i&&!i.fn){var o=i;i=w.extend("function"!=typeof o?o:{init:function(){this.on("routestart routechange"+(n===!0?" routeend":""),o)}})}"regexp"!==c.type(e)&&(e=(this.options.basePath+("."==e?"":e)).replace(/\/\//,"/"));var a,h=[],l=this;return s&&(l=new b({basePath:e}),l.items=this.items,l.itemsIdx=this.itemsIdx,l.parentRouter=this,e+="*"),i&&(a=this.items.push({id:t,path:e,keys:h,regexp:r(e,h),unit:i||b.View,options:n}),t&&(this.itemsIdx[t]=a-1)),s?l:a},removeRoute:function(t){t=this.itemsIdx[t]||t,this.items.splice(t,1)},createGroup:function(t,e,i,n){return this.route(t,e,i,n,!0)},closeGroup:function(){return this.parentRouter||this},_getUnits:function(t,e){var s=[];return i(e,function(e){var i=e.unit,r=[];o(t.path,e.regexp,e.keys,r)&&(i.__self===u&&(e.unit=i=new i(n({id:e.id,router:this,inited:!1},e.options))),i.requestParams=r,s.push(i))},this),s},_loadUnits:function(t,e){var n,s,r=[],o=function(t){s.push(t)};for(s=e.concat();n=s.shift();)if(n&&n.isActive(e)){if(t.params=n.requestParams,!y(n,t))return n.emit("access-denied",t),c.Deferred().reject(n.accessDeniedRedirectTo&&{redirectTo:n.accessDeniedRedirectTo,redirectParams:n.requestParams});if(i(n.units,o),n.loadData)try{n=n.loadData(t,this._navByHistory)}catch(a){return a.name="loadData",this.emit("error",a),c.Deferred().reject()}_(n)?s.push.apply(s,n):n&&r.push(n),delete t.params}return c.when.apply(c,r)},_doRouteUnits:function(t,e){i(e,function(e){var i=e.unit,n=!0,s=[],r=t.clone();if(r.params=s,o(r.path,e.regexp,e.keys,s)&&i.isActive(this.activeUnits)){if(i.request=r,i.inited!==!0&&i.__init(),i.active!==!0){n=!1,i.active=!0;try{i.emit("route-start",r)}catch(a){a.name="routestart",this.emit("error",a,r)}}try{i.emit("route",r)}catch(a){a.name="route",this.emit("error",a,r),this.emit("routeerror",a,r)}if(n)try{i.emit("route-change",r)}catch(a){a.name="routechange",this.emit("error",a,r)}}else if(i.active===!0&&!~c.inArray(i,this.activeUnits)){i.active=!1,i.request=r;try{i.emit("route-end",r)}catch(a){a.name="routeend",this.emit("geterror",a,r)}}},this)},_doRouteDone:function(t){if(this.activeRequest===t){if(this.request.url!=t.url&&(this.referrer=this.request,this.options.useHistory&&b.setLocation(t)),this.request=t,this._navByHistory||(this.history=this.history.slice(0,this.historyIdx+1),this.historyIdx=this.history.push(t.url)-1),this.items.length)try{this._doRouteUnits(t,this.items)}catch(e){e.name="route",this.emit("error",e)}var i=new Date-this.__ts;this.emit("route",[t,i]),this.log("Pilot.nav: "+i+"ms ("+t.path+t.search+")")}},_doRouteFail:function(t,e){if(e=e||{},this.activeRequest===t){var i=e.redirectTo;this.activeRequest=null,this.emit("route-fail",t,e),i&&(".."===i?(i=t.path.split("/"),""===i.pop()&&(i.pop(),i.push("")),i=i.join("/")):"function"==typeof i?i=i(t):this.get(i)&&(i=this.getUrl(i,e.redirectParams)),this.nav(i))}},log:function(e){!this.options.production&&t.console&&console.log(e)},error:function(e){this.options.production||(t.console&&console.error?console.error(e):this.log(e))},get:function(t){var e=this.getItem(t);return e&&e.unit},getItem:function(t){return this.items[this.itemsIdx[t]]},getUrl:function(t,e,i){var s,r,o=this.getItem(t),a=0;return o&&(e=n({},e,i),s=o.keys,r=o.path.replace(/:(\w+)\??(\/?)/g,function(t,i,n,r){return i=s[a++],r=i&&e[i.name],r?r+(n||""):"("+t+")"}).replace(/\(.*?:[^)]+\)+\??/g,"").replace(/\(|\)\??/g,"").replace(/\/+/g,"/")),r},start:function(t){this.started||this._nav(t||this.request,!1,!0)},_nav:function(t,e,i){var n=c.Deferred(),s=b.parseURL(t.href||t.url||t);if(this.started=!0,this._navByHistory=!!e,i||!this.activeRequest||this.activeRequest.url!=s.url){this.__ts=+new Date,this.emit("before-route",[s,this.__ts]);var r=this._getUnits(s,this.items);s.referrer=this.request.url,this.activeUnits=r,this.activeRequest=s,r.length?this._loadUnits(s,r).done(v(this,this._doRouteDone,s)).fail(v(this,this._doRouteFail,s)).then(n.resolve,n.reject):(this._doRouteDone(s),this.emit("404",s),n.reject())}else n.resolve();return n.promise()},nav:function(t,e,i){return c.isFunction(e)&&(i=e,e=!1),this._nav(t,!1,e).then(i,i)},go:function(t,e){var i=this.getUrl(t,e);return i?this.nav(i):c.Deferred().reject().promise()},hasBack:function(){return this.historyIdx>0},back:function(){return this.hasBack()?this._nav(this.history[--this.historyIdx],!0):c.Deferred().resolve()},hasForward:function(){return!!this.history[this.historyIdx+1]},forward:function(){return this.hasForward()?this._nav(this.history[++this.historyIdx],!0):c.Deferred().resolve}});b.parseURL=function(t){return new e(t)},e.fn=e.prototype={constructor:e,clone:function(){return new e(this.url)}},b.setLocation=function(t){b.pushState&&l.pushState?l.pushState(null,f.title,t.url):p.hash="#!"+t.path+t.search},b.getLocation=function(t){return t=t||""+p,b.pushState||(t=t.split(/#!?/).pop()),b.parseURL(t).path};var w=R.extend({data:{},boundAll:[],__lego:function(t){R.fn.__lego.call(this),n(this,t),i(this.boundAll,function(t){this[t]=this.bound(t)},this),this.inited!==!1&&this.__init()},__init:function(){this.inited=!0,this.emit("beforeInit"),this.init(),this.emit("init")},_exception:function(t,e){throw"["+this.uniqId+"."+t+"]: "+e},isActive:function(){return!0},bound:function(t){return"string"==typeof t&&(this[t]===u&&this._exception("bound",t+" -- method not found"),t=this[t]),v(this,t)},init:h,loadData:h,destroy:h,getUrl:function(t,e,i){return this.router.getUrl(t,e,i)},setData:function(t,e){return e?n(this.data,t):this.data=t,this},getData:function(){return this.data}}),I=w.extend({el:null,$el:c(),tag:null,tagName:null,className:"",parentNode:null,template:null,events:{},__init:function(){if(this.inited=!0,this.el)this.setElement(c(this.el,this.parentNode));else if(this.tagName||this.tag){var t=this.tagName,e=this.parentNode,i=this.className;this.tag&&(t=this.tag.match(/^(#[^\s]+)?\s*([^\.]+)\.?([^$]+)?/),t[1]&&(e=t[1]),t[3]&&(i=t[3].split(".").join(" ")),t=t[2]),this.el=f.createElement(t),this.$el=c(this.el),i&&this.$el.addClass(i),e&&(c.isReady?this.$el.appendTo(e):c(this.bound(function(){this.$el.appendTo(e)})))}else this.$el[0]=u,this.$el.length=0;this.on("routestart.view routeend.view",this.bound(function(t){this.toggleView("routeend"!=t.type)})),w.fn.__init.call(this)},toggleView:function(t){this.$el&&this.$el.css("display",t?"":"none")},setElement:function(t){return this.undelegateEvents(),t?(this.$el=c(t),this.delegateEvents()):(this.$el[0]=u,this.$el.length=0),this.el=this.$el[0],this},delegateEvents:function(t){return this.undelegateEvents(),i(t||this.events,function(t,e){e=e.match(/^([^\s]+)\s+(.+)/),this.$el.delegate(e[2],e[1]+".delegateEvents"+this.cid,this.bound(t))},this),this},undelegateEvents:function(){return this.$el&&this.$el.unbind(".delegateEvents"+this.cid),this},$:function(t){var e=this.$el;return void 0!==t&&(e="string"==typeof t?e.find(t):c(t)),e},getHtml:function(t){return t=t?n({},this.getData(),t):this.getData(),this.template(t)},render:function(){var t=this.getHtml();"string"==typeof t&&(this.emit("before-render"),this.$el.empty().each(function(){this.innerHTML=t}),this.emit("render"))}});b.utils={each:i,extend:n,qs:{parse:s,stringify:c.param}},b.access={},b.Route=w,b.View=I,b.Class=x,b.Emitter=R,b.Request=e,b.version="1.2.1",t.Pilot=b,"function"==typeof define&&define.amd&&define("Pilot",[],function(){return b})})("undefined"!=typeof module&&module.exports||window);