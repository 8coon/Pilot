/*! Pilot 1.5.0 - MIT | git://github.com/rubaxa/Pilot.git */
!function(a){"use strict";function b(a,b){s.test(a)||(a="/"==a.charAt(0)?"//"+r.hostname+a:r.pathname.substr(0,r.pathname.lastIndexOf("/")+1)+a,a="//"==a.substr(0,2)?r.protocol+a:r.hostname+a,s.test(a)||(a=r.protocol+"//"+a)),a=a.substr(0,7)+a.substr(7).replace(/\/+/g,"/");var c=(a.split("?")[1]||"").replace(/#.*/,""),d=e(c),f=a.match(s)[0].length+3,g=a.substr(a.indexOf("/",f)).replace(/\?.*/,""),h=this;c&&(c="?"+c),h.url=a,h.href=a,h.query=d,h.search=c,h.path=g,h.pathname=g,h.hash=a.replace(/^[^#]+#/,""),h.params={},h.referrer=b}function c(a,b,c){if(a){var d=0,e=a.length;if(d in a&&e!==m)for(;e>d;d++)b.call(c,a[d],d,a);else for(d in a)a.hasOwnProperty(d)&&b.call(c,a[d],d,a)}}function d(a,b){var c,d=arguments,e=1,f=d.length;for(a=a||{};f>e;e++)if(b=d[e],b&&/object|function/.test(typeof b))for(c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a}function e(a){var b={};if("string"==typeof a)for(var c,d,e,f=a.split("&"),g=0,h=f.length;h>g;g++){c=f[g].split("="),d=c[0],e=void 0===c[1]?"":c[1];try{e=decodeURIComponent(e)}catch(i){e=unescape(e)}d.length>0&&(void 0===b[d]?b[d]=e:b[d]instanceof Array?b[d].push(e):b[d]=[b[d],e])}return b}function f(a,b,c,d,e){var f=a[b];a[b]=function(g){var h,i=d?a.router:a,j=(d?"#"+a.getRouteName()+".":"")+(e||b)+(c?"."+g:"");return(!c||"profile"!==g)&&A(i,j),h=f.apply(a,arguments),(!c||"profile"!==g)&&B(i,j),h}}function g(a,b){function c(a){return a.toFixed(4)}function d(a,b){var e=0,f=a.length;if(f){for(console[b&&f>2&&console.groupCollapsed?"groupCollapsed":"group"](a.name,"~",c(a.dt));f>e;e++)d(a[e],1);console.groupEnd()}else{var g=c(a.dt);console.log("%c "+a.name+": "+g,"color: "+k[(1>g)+(g>1)+(g>4)+(g>8)+(g>10)]+(g>20?"; font-weight: bold":""))}}for(var e,f,g,h=0,i=b.length,j=[],k=["#ccc","#666","#333","#c00","red"];i>h;h++)if(e=b[h],f=b[h+1],f&&e[0]==f[0]&&f[2])g=e[1]-b[h-1][1],g>.1&&j.push({name:"<<between>>",dt:g}),j.push({name:e[0],dt:f[1]-e[1]}),h++;else if(e[2])j.dt+=e[1],j=j.parent;else{var l=[];l.parent=j,l.name=e[0],l.dt=-e[1],j.push(l),j=l}j[0].name="Pilot "+a,d(j[0])}function h(a,b,c){return a instanceof RegExp?a:(w(a)&&(a="("+a.join("|")+")"),a=a.concat("/?").replace(/(\/\(|\(\/)/g,"(?:/").replace(/(\/)?(\.)?:(\w+)(?:(\([^?].*?\)))?(\?)?(\*)?/g,function(a,d,e,f,g,h,i){return b.push({name:f,optional:!!h,rule:c[f]}),d=d||"",""+(h?"":d)+"(?:"+(h?d:"")+(e||"")+(g||e&&"([^/.]+?)"||"([^/]+?)")+")"+(h||"")+(i?"(/*)?":"")}).replace(/([\/.])/g,"\\$1").replace(/\*/g,"(.*)"),new RegExp("^"+a+"$","i"))}function i(a,b,c,d){if(c){var e,f,g,h=1,i=b.exec(a.path);if(!i)return!1;for(e=i.length;e>h;++h)if(f=c[h-1],g="string"==typeof i[h]?decodeURIComponent(i[h]):i[h],f){if(null!=f.rule&&f.rule(g,a)!==!0)return!1;d[f.name]=g}else d.push(g);return!0}return b.test(a.path)}var j=a.performance||{};j.now=function(){return j.now||j.mozNow||j.msNow||j.oNow||j.webkitNow}();var k=0,l=function(){},m=void 0,n=a.jQuery||a.Zepto||a.ender||l,o=n.Deferred,p=a.history,q=a.document,r=a.location,s=/^(https?|file)/i,t=[].slice,u={}.toString,v=function(a,b){var c=t.call(arguments,2);return b.bind?b.bind.apply(b,[a].concat(c)):function(){return b.apply(a,c.concat(t.call(arguments)))}},w=Array.isArray||n.isArray,x=function(a){return n.when.apply(n,a)},y=function(a,b){var c=a.accessPermission,d=E.access[c];return void 0===c||(d?d(b):!1)},z=j.now?function(){return j.now()}:function(){return(new Date).getTime()},A=function(a,b){a._profilerTimers.push([b,z(),0])},B=function(a,b){a._profilerTimers.push([b,z(),1])},C=function(a){var b=function(){if(b.fn.singleton){if(b.__inst__)return b.__inst__;b.__inst__=this}this.cid=this.uniqId=++k,this.__lego.apply(this,arguments)};return b.fn=b.prototype=a||{},b.fn.__self=b.fn.constructor=b,b.extend=function(a){var c=C();return l.prototype=this.fn,c.prototype=new l,d(c,this),d(c.fn=c.prototype,a),c.fn.__fn=c.fn.__super__=this.fn,c.fn.__self=c.fn.__self__=b.fn.constructor=c,c},b},D=C({__lego:function(){var a=n(this);c({on:"bind",off:"unbind",fire:"triggerHandler"},function(b,c){this[c]=function(){return a[b].apply(a,arguments),this}},this)},emit:function(a,b){var c,d=("on-"+a).replace(/-(.)/g,function(a,b){return b.toUpperCase()}),e=n.Event(a.replace(/-/g,""));return e.target=this,(this[d]===m||this[d].apply(this,[e].concat(b))!==!1)&&(e.isImmediatePropagationStopped()||(c=this.fire(e,b))),c}}),E=D.extend({__lego:function(b){if(D.fn.__lego.call(this),this.options=b=d({el:null,selector:"a[href],[data-nav]",basePath:"/",production:a.Pilot&&a.Pilot.production,useHistory:!1},b),this.items=[],this.itemsIdx={},this.request=this.referrer=E.parseURL(E.getLocation()),this.history=[],this.historyIdx=0,b.useHistory&&n(a).bind("popstate hashchange",v(this,function(){this.nav(E.getLocation())})),b.profile){f(this,"emit",!0),c({prepare:"_getUnits","load data":"_loadUnits","do routes":"_doRouteUnits"},function(a,b){f(this,a,0,0,b)},this);var e=this.nav;this.nav=function(){var a=this,b=a._profilerTimers=[],c=function(){B(a,"Pilot"),a.emit("profile",[b]),g(a.request.path,b)};return A(a,"Pilot"),e.apply(a,arguments).then(c,c)}}b.el&&n(b.el).delegate(b.selector,"click tap",v(this,function(a){this.nav(E.getLocation(a.currentTarget.getAttribute("data-nav")||a.currentTarget.getAttribute("href"))),a.preventDefault()})),this.init()},init:function(){},route:function(a,b,c,d,e){var f=this.addRoute(a,b,c,d,e);return e?f:this},addRoute:function(a,b,c,e,f){if(/string|regexp/i.test(u.call(b))||(e=c,c=b,b=a,a=m),c&&!c.fn){var g=c;c=F.extend("function"!=typeof g?g:{init:function(){this.on("routestart routechange"+(e===!0?" routeend":""),g)}})}"regexp"!==n.type(b)&&(b=(this.options.basePath+("."==b?"":b)).replace(/\/\//,"/"));var i,j=[],k=this,l=e&&e.paramsRules||c&&c.fn.paramsRules||{};return f&&(k=new E({basePath:b,paramsRules:l}),k.items=this.items,k.itemsIdx=this.itemsIdx,k.parentRouter=this,b+="*"),c&&(i=this.items.push({id:a,path:b,keys:j,regexp:h(b,j,d({},k.options.paramsRules,l)),unit:c||E.View,options:e}),a&&(this.itemsIdx[a]=i-1)),f?k:i},removeRoute:function(a){a=this.itemsIdx[a]||a,this.items.splice(a,1)},createGroup:function(a,b,c,d){return this.route(a,b,c,d,!0)},closeGroup:function(){return this.parentRouter||this},_getUnits:function(a,b){var e=[];return c(b,function(b){var c=b.unit,f=[];i(a,b.regexp,b.keys,f)&&(c.__self===m&&(b.unit=c=new c(d({id:b.id,router:this,inited:!1},b.options))),c.requestParams=f,e.push(c))},this),e},_loadUnits:function(a,b){var d,e,f,g,h,i,j=[],k=[],l=this.options.production,m=function(a,b){a.__self||(a.fn&&a.fn.__lego||(a=G.extend(a)),a=new a({router:this.router,inited:!1,parentRoute:this,subrouteName:b}),a.el=a.el||'[data-subview-id="'+b+'"]',this.subroutes[b]=a),a.requestParams=this.requestParams,h.push(a)};for(h=b.concat();d=h.shift();)if(d&&d.isActive(b)){if(a.params=d.requestParams,e=null,d.setRouteError(null),f=y(d,a),g=d.accessDeniedRedirectTo&&{redirectTo:d.accessDeniedRedirectTo,redirectParams:d.requestParams},!f)return d.emit("access-denied",a),o().reject(g);if(f.then&&(f.denied=g,k.push(f)),c(d.subroutes,m,d),d.loadData)if(f&&f.then)e=v(d,"loadData",a,this._navByHistory);else if(l)try{e=d.loadData(a,this._navByHistory)}catch(n){e=o().reject(n),n.name="loadData",this.emit("error",n,a)}else e=d.loadData(a,this._navByHistory);e&&("function"==typeof e.then&&e.then(v(d,d.setLoadedData),v(d,d.setRouteError)),j.push(e)),e&&"function"==typeof e.then||d.setLoadedData(e),delete a.params}return k.length?(i=o(),x(k).then(function(){x(j).then(i.resolve,i.reject)},function(){i.reject(f.denied)})):i=x(j),i.promise()},_doRouteUnits:function(a,b){var d=this.options,e=d.profile,f=d.production,g=v(this,function(a,b,c){if(f)try{a.emit(b,c)}catch(d){d.name=b.replace("-",""),this.emit("error",d,c),a.setRouteError(d)}else a.emit(b,c)});c(b,function(b){var c=b.unit,d=!0,f=[],h=a.clone();e&&c.__self&&A(this,"#"+c.getRouteName()),h.params=f,i(h,b.regexp,b.keys,f)&&c.isActive(this.activeUnits)?(c.request=h,c.inited!==!0&&c.__init(),c.active!==!0&&(d=!1,c.active=!0,g(c,"route-start",h)),g(c,"route",h),d&&g(c,"route-change",h)):c.active!==!0||~n.inArray(c,this.activeUnits)||(c.active=!1,c.request=h,g(c,"route-end",h)),e&&c.__self&&B(this,"#"+c.getRouteName())},this)},_doRouteDone:function(a){if(this.activeRequest===a){this.request.url!=a.url&&(this.referrer=this.request,this.options.useHistory&&E.setLocation(a)),this.request=a,this._navByHistory||(this.history=this.history.slice(0,this.historyIdx+1),this.historyIdx=this.history.push(a.url)-1),this.items.length&&this._doRouteUnits(a,this.items);var b=new Date-this.__ts;this.emit("route",[a,b]),this.emit("routeend",[a,b]),this.options.profile||this.log("Pilot.nav: "+b+"ms ("+a.path+a.search+")")}},_doRouteFail:function(a,b){if(b=b||{},this.activeRequest===a){var c=b.redirectTo;this.activeRequest=null,c?(".."===c?(c=a.path.split("/"),""===c.pop()&&(c.pop(),c.push("")),c=c.join("/")):"function"==typeof c?c=c.call(this,a):this.get(c)&&(c=this.getUrl(c,b.redirectParams)),this.request=a,this.nav(c)):this.emit("route-fail",a,b)}},log:function(b){!this.options.production&&a.console&&console.log(b)},error:function(b){this.options.production||(a.console&&console.error?console.error(b):this.log(b))},getFailRoutes:function(){return n(this.activeUnits).filter(function(a,b){return!!b.getRouteError()}).get()},get:function(a){var b=this.getItem(a);return b&&b.unit},getItem:function(a){return this.items[this.itemsIdx[a]]},getUrl:function(a,b,c){var e,f,g=this.getItem(a),h=0;return g&&(b=d({},b,c),e=g.keys,f=g.path.replace(/:(\w+)\??(\/?)/g,function(a,c,d,f){return c=e[h++],f=c&&b[c.name],f?f+(d||""):"("+a+")"}).replace(/\(.*?:[^)]+\)+\??/g,"").replace(/\(|\)\??/g,"").replace(/\/+/g,"/")),(E.pushState?"":"#!")+f},start:function(a){this.started||this._nav(a||this.request,!1,!0)},_nav:function(a,b,c){var d=o(),e=E.parseURL(a.href||a.url||a);if(this.started=!0,this._navByHistory=!!b,c||!this.activeRequest||this.activeRequest.url!=e.url){this.__ts=+new Date,this.emit("before-route",[e,this.__ts]);var f=this._getUnits(e,this.items);e.referrer=this.request.url,this.activeUnits=f,this.activeRequest=e,f.length?this._loadUnits(e,f).done(v(this,this._doRouteDone,e)).fail(v(this,this._doRouteFail,e)).then(d.resolve,d.reject):(this._doRouteDone(e),this.emit("404",e),d.reject())}else d.resolve();return d.promise()},nav:function(a,b,c){return n.isFunction(b)&&(c=b,b=!1),this._nav(a,!1,b).then(c,c)},go:function(a,b){var c=this.getUrl(a,b);return c?this.nav(c):o().reject().promise()},hasBack:function(){return this.historyIdx>0},hasForward:function(){return!!this.history[this.historyIdx+1]},back:function(){return this.hasBack()?this._nav(this.history[--this.historyIdx],!0):o().resolve()},forward:function(){return this.hasForward()?this._nav(this.history[++this.historyIdx],!0):o().resolve()}});E.parseURL=function(a){return new b(a)},b.fn=b.prototype={constructor:b,clone:function(){return new b(this.url,this.referrer)},toString:function(){return this.url}},E.setLocation=function(a){E.pushState&&p.pushState?p.pushState(null,q.title,a.url):r.hash="#!"+a.path+a.search},E.getLocation=function(a){return a=a||r.toString(),E.pushState||(a=a.split(/#!?/).pop()),E.parseURL(a).path};var F=D.extend({data:{},boundAll:[],paramsRules:{},subroutes:null,__lego:function(a){D.fn.__lego.call(this),d(this,a),this.loadDataOnce&&(this.loadData=function(a){var b=this.loadDataOnce(a);return this.loadData=function(){return b},b}),this.subroutes=this.subroutes||this.subviews,c(this.boundAll,function(a){this[a]=this.bound(a)},this),this.router&&this.router.options.profile&&(f(this,"__initSub",0,1,"subroutes"),c({init:0,loadData:0,render:0,emit:1},function(a,b){f(this,b,a,1)},this)),this.on("routestart route routechange routeend",this.bound(function(a,b){var d=a.type.substr(5);d=d?"route-"+d:"route",c(this.subroutes,function(a){a.emit(d,b)})})),this.inited!==!1&&this.__init()},__init:function(){this.inited=!0,this.emit("beforeInit"),this.init(),this.subroutes&&this.__initSub(),this.emit("init")},__initSub:function(){for(var a in this.subroutes)this.subroutes[a].__init()},_exception:function(a,b){throw"["+this.uniqId+"."+a+"]: "+b},isActive:function(){return!0},bound:function(a){return"string"==typeof a&&(this[a]===m&&this._exception("bound",a+" -- method not found"),a=this[a]),v(this,a)},setRouteError:function(a){return this._routeError=a,this},getRouteError:function(){return this._routeError},init:l,loadData:l,loadDataOnce:null,destroy:l,getUrl:function(a,b,c){return"string"!=typeof a&&(c=b,b=a,a=this.id),this.router.getUrl(a,b,c)},setLoadedData:function(a){return this.loadedData=a,this},getLoadedData:function(){return this.loadedData},setData:function(a,b){return b?d(this.data,a):this.data=a,this},getData:function(){return this.data},getRouteName:function(){return(this.parentRoute?this.parentRoute.getRouteName()+".":"")+(this.id||this.subrouteName||this.uniqId)}}),G=F.extend({el:null,$el:n(),tag:null,tagName:null,className:"",parentNode:null,template:null,toggleEffect:"toggle",events:{},__init:function(){if(this.inited=!0,this.__init=l,this.el)this.setElement(n(this.el,this.parentNode));else if(this.tagName||this.tag){var a=this.tagName,b=this.parentNode,d=this.className;this.tag&&(a=this.tag.match(/^(#[^\s]+)?\s*([^\.]+)\.?([^$]+)?/),a[1]&&(b=a[1]),a[3]&&(d=a[3].split(".").join(" ")),a=a[2]),this.el=q.createElement(a),this.$el=n(this.el),d&&this.$el.addClass(d),b&&(n.isReady?this.$el.appendTo(b):n(this.bound(function(){this.$el.appendTo(b)})))}else this.$el[0]=m,this.$el.length=0;this.on("routestart.view routeend.view",this.bound(function(a,b){this._toggleView("routeend"!=a.type,b)})),F.fn.__init.call(this),c(this.subroutes,function(a){a.parentNode=this.el,a.__init()},this)},_toggleView:function(a,b){var c=G.toggleEffect[this.toggleEffect];this.$el&&c&&c.call(this,this.$el,a,b)},setElement:function(a){return this.undelegateEvents(),a?(this.$el=n(a),this.delegateEvents()):(this.$el[0]=m,this.$el.length=0),this.el=this.$el[0],this},delegateEvents:function(a){return this.undelegateEvents(),c(a||this.events,function(a,b){b=b.match(/^([^\s]+)\s+(.+)/),this.$el.delegate(b[2],b[1]+".delegateEvents"+this.cid,this.bound(a))},this),this},undelegateEvents:function(){return this.$el&&this.$el.unbind(".delegateEvents"+this.cid),this},$:function(a){var b=this.$el;return void 0!==a&&(b="string"==typeof a?b.find(a):n(a)),b},getHtml:function(a){return a=a?d({},this.getData(),a):this.getData(),this.template(a)},render:function(){var a=this.getHtml();"string"==typeof a&&(this.emit("before-render"),this.$el.empty().each(function(){this.innerHTML=a}),this.emit("render"))}});G.toggleEffect=function(a,b){return b&&(G.toggleEffect[a]=b),G.toggleEffect[a]},G.toggleEffect("toggle",function(a,b){a.css("display",b?"":"none")}),E.utils={each:c,extend:d,qs:{parse:e,stringify:n.param}},E.access={extend:function(a){d(this,a)}},E.Route=F,E.View=G,E.Class=C,E.Emitter=D,E.Request=b,E.create=function(a,b){b||(b=a,a={});var e=function g(a,b,c){var e,f,h={id:a.id||++k,opts:{},path:b=b.replace(/\/\.?\/+/g,"/")},i=[h];if(h.opts.el='[data-view-id="'+h.id+'"]',c&&c.paramsRules&&(h.paramsRules=d({},c.paramsRules,h.paramsRules)),"function"==typeof a)h.opts.onRoute=function(b,d){var e=this.router.get(c.id);a.call(e,d)};else for(e in a)f=a[e],"id"==e||"ctrl"==e?h[e]=f:"404"==e?(h.dir=!0,h[e]=g(f,b,h)[0]):/^\.?\//.test(e)?(h.dir=!0,i.push.apply(i,g(f,b+e,h))):h.opts[e]=f;return i}(b,"/");a.el=e[0].opts.el;var f=new E(a);return c(e,function(a){var b=a["404"];a.opts.__dir=a.dir,f.addRoute(a.id,a.path+(a.dir?"?*":""),a.ctrl||G,a.opts),b&&(b.opts.__404=!0,b.opts.isActive=function(a){for(var b,c,d=0,e=a.length;e>d;d++)if(b=a[d],b.__404)c=b;else if(!b.__dir)return!1;return this===c},f.route(b.id,b.path+"*",b.ctrl||G,b.opts))}),f},E.version="1.5.0",a.Pilot=E,"function"==typeof define&&define.amd?define("Pilot",[],function(){return E}):a.ajs&&ajs.loaded&&ajs.loaded("{pilot}Pilot")}("undefined"!=typeof module&&module.exports||window);