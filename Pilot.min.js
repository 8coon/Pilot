/*! Pilot 1.3.0 - MIT | git://github.com/rubaxa/Pilot.git */
(function(t){"use strict";function e(t){g.test(t)||(t="/"==t.charAt(0)?"//"+d.hostname+t:d.pathname.substr(0,d.pathname.lastIndexOf("/")+1)+t,t="//"==t.substr(0,2)?d.protocol+t:d.hostname+t,g.test(t)||(t=d.protocol+"//"+t)),t=t.substr(0,7)+t.substr(7).replace(/\/+/g,"/");var e=(t.split("?")[1]||"").replace(/#.*/,""),i=s(e),n=t.match(g)[0].length+3,r=t.substr(t.indexOf("/",n)).replace(/\?.*/,""),o=this;e&&(e="?"+e),o.url=t,o.href=t,o.query=i,o.search=e,o.path=r,o.pathname=r,o.hash=t.replace(/^[^#]+#/,""),o.params={}}function i(t,e,i){if(t){var n=0,s=t.length;if(n in t&&s!==u)for(;s>n;n++)e.call(i,t[n],n,t);else for(n in t)t.hasOwnProperty(n)&&e.call(i,t[n],n,t)}}function n(t,e){var i,n=arguments,s=1,r=n.length;for(t=t||{};r>s;s++)if(e=n[s],e&&/object|function/.test(typeof e))for(i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);return t}function s(t){var e={};if("string"==typeof t)for(var i,n,s,r=t.split("&"),o=0,a=r.length;a>o;o++){i=r[o].split("="),n=i[0],s=void 0===i[1]?"":i[1];try{s=decodeURIComponent(s)}catch(h){s=unescape(s)}n.length>0&&(void 0===e[n]?e[n]=s:e[n]instanceof Array?e[n].push(s):e[n]=[e[n],s])}return e}function r(t,e,i){return t instanceof RegExp?t:(y(t)&&(t="("+t.join("|")+")"),t=t.concat("/?").replace(/(\/\(|\(\/)/g,"(?:/").replace(/(\/)?(\.)?:(\w+)(?:(\([^?].*?\)))?(\?)?(\*)?/g,function(t,n,s,r,o,a,h){return e.push({name:r,optional:!!a,rule:i[r]}),n=n||"",""+(a?"":n)+"(?:"+(a?n:"")+(s||"")+(o||s&&"([^/.]+?)"||"([^/]+?)")+")"+(a||"")+(h?"(/*)?":"")}).replace(/([\/.])/g,"\\$1").replace(/\*/g,"(.*)"),RegExp("^"+t+"$","i"))}function o(t,e,i,n){if(i){var s,r,o,a=1,h=e.exec(t.path);if(!h)return!1;for(s=h.length;s>a;++a)if(r=i[a-1],o="string"==typeof h[a]?decodeURIComponent(h[a]):h[a],r){if(r.rule&&r.rule(o,t)!==!0)return!1;n[r.name]=o}else n.push(o);return!0}return e.test(t.path)}var a=0,h=function(){},u=void 0,c=t.jQuery||t.Zepto||t.ender||h,l=c.Deferred,f=t.history,p=t.document,d=t.location,g=/^(https?|file)/i,v=[].slice,m={}.toString,_=function(t,e){var i=v.call(arguments,2);return e.bind?e.bind.apply(e,[t].concat(i)):function(){return e.apply(t,i.concat(v.call(arguments)))}},y=Array.isArray||c.isArray,R=function(t){return c.when.apply(c,t)},b=function(t,e){var i=t.accessPermission,n=q.access[i];return void 0===i||(n?n(e):!1)},w=function(t){var e=function(){if(e.fn.singleton){if(e.__inst__)return e.__inst__;e.__inst__=this}this.cid=this.uniqId=++a,this.__lego.apply(this,arguments)};return e.fn=e.prototype=t||{},e.fn.__self=e.fn.constructor=e,e.extend=function(t){var i=w();return h.prototype=this.fn,i.prototype=new h,n(i,this),n(i.fn=i.prototype,t),i.fn.__fn=i.fn.__super__=this.fn,i.fn.__self=i.fn.__self__=e.fn.constructor=i,i},e},x=w({__lego:function(){var t=c(this);i({on:"bind",off:"unbind",fire:"triggerHandler"},function(e,i){this[i]=function(){return t[e].apply(t,arguments),this}},this)},emit:function(t,e){var i,n=("on-"+t).replace(/-(.)/g,function(t,e){return e.toUpperCase()}),s=c.Event(t.replace(/-/g,""));return s.target=this,(this[n]===u||this[n].apply(this,[s].concat(e))!==!1)&&(s.isImmediatePropagationStopped()||(i=this.fire(s,e))),i}}),q=x.extend({__lego:function(e){x.fn.__lego.call(this),this.options=e=n({el:null,selector:"a[href],[data-nav]",basePath:"/",production:t.Pilot&&t.Pilot.production,useHistory:!1},e),this.items=[],this.itemsIdx={},this.request=this.referrer=q.parseURL(q.getLocation()),this.history=[],this.historyIdx=0,e.useHistory&&c(t).bind("popstate hashchange",_(this,function(){this.nav(q.getLocation())})),e.el&&c(e.el).delegate(e.selector,"click",_(this,function(t){this.nav(q.getLocation(t.currentTarget.getAttribute("data-nav")||t.currentTarget.getAttribute("href"))),t.preventDefault()})),this.init()},init:function(){},route:function(t,e,i,n,s){var r=this.addRoute(t,e,i,n,s);return s?r:this},addRoute:function(t,e,i,s,o){if(/string|regexp/i.test(m.call(e))||(s=i,i=e,e=t,t=u),i&&!i.fn){var a=i;i=I.extend("function"!=typeof a?a:{init:function(){this.on("routestart routechange"+(s===!0?" routeend":""),a)}})}"regexp"!==c.type(e)&&(e=(this.options.basePath+("."==e?"":e)).replace(/\/\//,"/"));var h,l=[],f=this,p=s&&s.paramsRules||i&&i.fn.paramsRules||{};return o&&(f=new q({basePath:e,paramsRules:p}),f.items=this.items,f.itemsIdx=this.itemsIdx,f.parentRouter=this,e+="*"),i&&(h=this.items.push({id:t,path:e,keys:l,regexp:r(e,l,n({},f.options.paramsRules,p)),unit:i||q.View,options:s}),t&&(this.itemsIdx[t]=h-1)),o?f:h},removeRoute:function(t){t=this.itemsIdx[t]||t,this.items.splice(t,1)},createGroup:function(t,e,i,n){return this.route(t,e,i,n,!0)},closeGroup:function(){return this.parentRouter||this},_getUnits:function(t,e){var s=[];return i(e,function(e){var i=e.unit,r=[];o(t,e.regexp,e.keys,r)&&(i.__self===u&&(e.unit=i=new i(n({id:e.id,router:this,inited:!1},e.options))),i.requestParams=r,s.push(i))},this),s},_loadUnits:function(t,e){var n,s,r,o,a,h=[],u=[],c=this.options.production,f=function(t,e){t.__self||(t=new t({inited:!1}),t.el=t.el||'[data-subview-id="'+e+'"]',t.router=this.router,t.parentView=this,this.subviews[e]=t),t.requestParams=this.requestParams,o.push(t)};for(o=e.concat();n=o.shift();)if(n&&n.isActive(e)){if(t.params=n.requestParams,s=b(n,t),r=n.accessDeniedRedirectTo&&{redirectTo:n.accessDeniedRedirectTo,redirectParams:n.requestParams},!s)return n.emit("access-denied",t),l().reject(r);if(s.then&&(s.denied=r,u.push(s)),i(n.subviews,f,n),n.loadData)if(s&&s.then)n=_(n,"loadData",t,this._navByHistory);else if(c)try{n=n.loadData(t,this._navByHistory)}catch(p){n=l().reject(p),p.name="loadData",this.emit("error",p,t)}else n=n.loadData(t,this._navByHistory);y(n)?o.push.apply(o,n):n&&h.push(n),delete t.params}return u.length?(a=l(),R(u).then(function(){R(h).then(a.resolve,a.reject)},function(){a.reject(s.denied)})):a=R(h),a.promise()},_doRouteUnits:function(t,e){var n=this.options.production,s=_(this,function(t,e,i){if(n)try{t.emit(e,i)}catch(s){s.name=e.replace("-",""),this.emit("error",s,i)}else t.emit(e,i)});i(e,function(e){var i=e.unit,n=!0,r=[],a=t.clone();a.params=r,o(a,e.regexp,e.keys,r)&&i.isActive(this.activeUnits)?(i.request=a,i.inited!==!0&&i.__init(),i.active!==!0&&(n=!1,i.active=!0,s(i,"route-start",a)),s(i,"route",a),n&&s(i,"route-change",a)):i.active!==!0||~c.inArray(i,this.activeUnits)||(i.active=!1,i.request=a,s(i,"route-end",a))},this)},_doRouteDone:function(t){if(this.activeRequest===t){this.request.url!=t.url&&(this.referrer=this.request,this.options.useHistory&&q.setLocation(t)),this.request=t,this._navByHistory||(this.history=this.history.slice(0,this.historyIdx+1),this.historyIdx=this.history.push(t.url)-1),this.items.length&&this._doRouteUnits(t,this.items);var e=new Date-this.__ts;this.emit("route",[t,e]),this.log("Pilot.nav: "+e+"ms ("+t.path+t.search+")")}},_doRouteFail:function(t,e){if(e=e||{},this.activeRequest===t){var i=e.redirectTo;this.activeRequest=null,this.emit("route-fail",t,e),i&&(".."===i?(i=t.path.split("/"),""===i.pop()&&(i.pop(),i.push("")),i=i.join("/")):"function"==typeof i?i=i.call(this,t):this.get(i)&&(i=this.getUrl(i,e.redirectParams)),this.nav(i))}},log:function(e){!this.options.production&&t.console&&console.log(e)},error:function(e){this.options.production||(t.console&&console.error?console.error(e):this.log(e))},get:function(t){var e=this.getItem(t);return e&&e.unit},getItem:function(t){return this.items[this.itemsIdx[t]]},getUrl:function(t,e,i){var s,r,o=this.getItem(t),a=0;return o&&(e=n({},e,i),s=o.keys,r=o.path.replace(/:(\w+)\??(\/?)/g,function(t,i,n,r){return i=s[a++],r=i&&e[i.name],r?r+(n||""):"("+t+")"}).replace(/\(.*?:[^)]+\)+\??/g,"").replace(/\(|\)\??/g,"").replace(/\/+/g,"/")),r},start:function(t){this.started||this._nav(t||this.request,!1,!0)},_nav:function(t,e,i){var n=l(),s=q.parseURL(t.href||t.url||t);if(this.started=!0,this._navByHistory=!!e,i||!this.activeRequest||this.activeRequest.url!=s.url){this.__ts=+new Date,this.emit("before-route",[s,this.__ts]);var r=this._getUnits(s,this.items);s.referrer=this.request.url,this.activeUnits=r,this.activeRequest=s,r.length?this._loadUnits(s,r).done(_(this,this._doRouteDone,s)).fail(_(this,this._doRouteFail,s)).then(n.resolve,n.reject):(this._doRouteDone(s),this.emit("404",s),n.reject())}else n.resolve();return n.promise()},nav:function(t,e,i){return c.isFunction(e)&&(i=e,e=!1),this._nav(t,!1,e).then(i,i)},go:function(t,e){var i=this.getUrl(t,e);return i?this.nav(i):l().reject().promise()},hasBack:function(){return this.historyIdx>0},hasForward:function(){return!!this.history[this.historyIdx+1]},back:function(){return this.hasBack()?this._nav(this.history[--this.historyIdx],!0):l().resolve()},forward:function(){return this.hasForward()?this._nav(this.history[++this.historyIdx],!0):l().resolve()}});q.parseURL=function(t){return new e(t)},e.fn=e.prototype={constructor:e,clone:function(){return new e(this.url)},toString:function(){this.url}},q.setLocation=function(t){q.pushState&&f.pushState?f.pushState(null,p.title,t.url):d.hash="#!"+t.path+t.search},q.getLocation=function(t){return t=t||""+d,q.pushState||(t=t.split(/#!?/).pop()),q.parseURL(t).path};var I=x.extend({data:{},boundAll:[],paramsRules:{},__lego:function(t){x.fn.__lego.call(this),n(this,t),i(this.boundAll,function(t){this[t]=this.bound(t)},this),this.inited!==!1&&this.__init()},__init:function(){this.inited=!0,this.emit("beforeInit"),this.init(),this.emit("init")},_exception:function(t,e){throw"["+this.uniqId+"."+t+"]: "+e},isActive:function(){return!0},bound:function(t){return"string"==typeof t&&(this[t]===u&&this._exception("bound",t+" -- method not found"),t=this[t]),_(this,t)},init:h,loadData:h,destroy:h,getUrl:function(t,e,i){return this.router.getUrl(t,e,i)},setData:function(t,e){return e?n(this.data,t):this.data=t,this},getData:function(){return this.data}}),$=I.extend({el:null,$el:c(),tag:null,tagName:null,className:"",parentNode:null,template:null,events:{},subviews:null,__init:function(){if(this.inited=!0,this.__init=h,this.el)this.setElement(c(this.el,this.parentNode));else if(this.tagName||this.tag){var t=this.tagName,e=this.parentNode,n=this.className;this.tag&&(t=this.tag.match(/^(#[^\s]+)?\s*([^\.]+)\.?([^$]+)?/),t[1]&&(e=t[1]),t[3]&&(n=t[3].split(".").join(" ")),t=t[2]),this.el=p.createElement(t),this.$el=c(this.el),n&&this.$el.addClass(n),e&&(c.isReady?this.$el.appendTo(e):c(this.bound(function(){this.$el.appendTo(e)})))}else this.$el[0]=u,this.$el.length=0;this.on("routestart.view routechange.view routeend.view",this.bound(function(t,e){var n=t.type;"routechange"!==n&&this.toggleView("routeend"!=n),i(this.subviews,function(t){t.emit(n,e)})})),I.fn.__init.call(this),i(this.subviews,function(t){t.parentNode=this.el,t.__init()},this)},toggleView:function(t){this.$el&&this.$el.css("display",t?"":"none")},setElement:function(t){return this.undelegateEvents(),t?(this.$el=c(t),this.delegateEvents()):(this.$el[0]=u,this.$el.length=0),this.el=this.$el[0],this},delegateEvents:function(t){return this.undelegateEvents(),i(t||this.events,function(t,e){e=e.match(/^([^\s]+)\s+(.+)/),this.$el.delegate(e[2],e[1]+".delegateEvents"+this.cid,this.bound(t))},this),this},undelegateEvents:function(){return this.$el&&this.$el.unbind(".delegateEvents"+this.cid),this},$:function(t){var e=this.$el;return void 0!==t&&(e="string"==typeof t?e.find(t):c(t)),e},getHtml:function(t){return t=t?n({},this.getData(),t):this.getData(),this.template(t)},render:function(){var t=this.getHtml();"string"==typeof t&&(this.emit("before-render"),this.$el.empty().each(function(){this.innerHTML=t}),this.emit("render"))}});q.utils={each:i,extend:n,qs:{parse:s,stringify:c.param}},q.access={extend:function(t){n(this,t)}},q.Route=I,q.View=$,q.Class=w,q.Emitter=x,q.Request=e,q.version="1.3.0",t.Pilot=q,"function"==typeof define&&define.amd&&define("Pilot",[],function(){return q})})("undefined"!=typeof module&&module.exports||window);