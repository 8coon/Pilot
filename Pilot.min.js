/*! Pilot 1.3.0 - MIT | git://github.com/rubaxa/Pilot.git */
(function(t){"use strict";function e(t){y.test(t)||(t="/"==t.charAt(0)?"//"+_.hostname+t:_.pathname.substr(0,_.pathname.lastIndexOf("/")+1)+t,t="//"==t.substr(0,2)?_.protocol+t:_.hostname+t,y.test(t)||(t=_.protocol+"//"+t)),t=t.substr(0,7)+t.substr(7).replace(/\/+/g,"/");var e=(t.split("?")[1]||"").replace(/#.*/,""),i=s(e),n=t.match(y)[0].length+3,r=t.substr(t.indexOf("/",n)).replace(/\?.*/,""),o=this;e&&(e="?"+e),o.url=t,o.href=t,o.query=i,o.search=e,o.path=r,o.pathname=r,o.hash=t.replace(/^[^#]+#/,""),o.params={}}function i(t,e,i){if(t){var n=0,s=t.length;if(n in t&&s!==p)for(;s>n;n++)e.call(i,t[n],n,t);else for(n in t)t.hasOwnProperty(n)&&e.call(i,t[n],n,t)}}function n(t,e){var i,n=arguments,s=1,r=n.length;for(t=t||{};r>s;s++)if(e=n[s],e&&/object|function/.test(typeof e))for(i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);return t}function s(t){var e={};if("string"==typeof t)for(var i,n,s,r=t.split("&"),o=0,a=r.length;a>o;o++){i=r[o].split("="),n=i[0],s=void 0===i[1]?"":i[1];try{s=decodeURIComponent(s)}catch(u){s=unescape(s)}n.length>0&&(void 0===e[n]?e[n]=s:e[n]instanceof Array?e[n].push(s):e[n]=[e[n],s])}return e}function r(t,e,i,n,s){var r=t[e];t[e]=function(o){var a,u=n?t.router:t,h=(n?"#"+t.getRouteName()+".":"")+(s||e)+(i?"."+o:"");return(!i||"profile"!==o)&&P(u,h),a=r.apply(t,arguments),(!i||"profile"!==o)&&$(u,h),a}}function o(t,e){function i(t){return t.toFixed(4)}function n(t,e){var s=0,r=t.length;if(r){for(console[e&&r>2&&console.groupCollapsed?"groupCollapsed":"group"](t.name,"~",i(t.dt));r>s;s++)n(t[s],1);console.groupEnd()}else{var o=i(t.dt);console.log("%c "+t.name+": "+o,"color: "+l[(1>o)+(o>1)+(o>4)+(o>8)+(o>10)]+(o>20?"; font-weight: bold":""))}}for(var s,r,o,a=0,u=e.length,h=[],l=["#ccc","#666","#333","#c00","red"];u>a;a++)if(s=e[a],r=e[a+1],r&&s[0]==r[0]&&r[2])o=s[1]-e[a-1][1],o>.1&&h.push({name:"<<between>>",dt:o}),h.push({name:s[0],dt:r[1]-s[1]}),a++;else if(s[2])h.dt+=s[1],h=h.parent;else{var c=[];c.parent=h,c.name=s[0],c.dt=-s[1],h.push(c),h=c}h[0].name="Pilot "+t,n(h[0])}function a(t,e,i){return t instanceof RegExp?t:(x(t)&&(t="("+t.join("|")+")"),t=t.concat("/?").replace(/(\/\(|\(\/)/g,"(?:/").replace(/(\/)?(\.)?:(\w+)(?:(\([^?].*?\)))?(\?)?(\*)?/g,function(t,n,s,r,o,a,u){return e.push({name:r,optional:!!a,rule:i[r]}),n=n||"",""+(a?"":n)+"(?:"+(a?n:"")+(s||"")+(o||s&&"([^/.]+?)"||"([^/]+?)")+")"+(a||"")+(u?"(/*)?":"")}).replace(/([\/.])/g,"\\$1").replace(/\*/g,"(.*)"),RegExp("^"+t+"$","i"))}function u(t,e,i,n){if(i){var s,r,o,a=1,u=e.exec(t.path);if(!u)return!1;for(s=u.length;s>a;++a)if(r=i[a-1],o="string"==typeof u[a]?decodeURIComponent(u[a]):u[a],r){if(r.rule&&r.rule(o,t)!==!0)return!1;n[r.name]=o}else n.push(o);return!0}return e.test(t.path)}function h(t,e){t._routeError=e}var l=t.performance||{};l.now=function(){return l.now||l.mozNow||l.msNow||l.oNow||l.webkitNow}();var c=0,f=function(){},p=void 0,d=t.jQuery||t.Zepto||t.ender||f,g=d.Deferred,m=t.history,v=t.document,_=t.location,y=/^(https?|file)/i,R=[].slice,b={}.toString,w=function(t,e){var i=R.call(arguments,2);return e.bind?e.bind.apply(e,[t].concat(i)):function(){return e.apply(t,i.concat(R.call(arguments)))}},x=Array.isArray||d.isArray,q=function(t){return d.when.apply(d,t)},U=function(t,e){var i=t.accessPermission,n=E.access[i];return void 0===i||(n?n(e):!1)},I=l.now?function(){return l.now()}:function(){return(new Date).getTime()},P=function(t,e){t._profilerTimers.push([e,I(),0])},$=function(t,e){t._profilerTimers.push([e,I(),1])},D=function(t){var e=function(){if(e.fn.singleton){if(e.__inst__)return e.__inst__;e.__inst__=this}this.cid=this.uniqId=++c,this.__lego.apply(this,arguments)};return e.fn=e.prototype=t||{},e.fn.__self=e.fn.constructor=e,e.extend=function(t){var i=D();return f.prototype=this.fn,i.prototype=new f,n(i,this),n(i.fn=i.prototype,t),i.fn.__fn=i.fn.__super__=this.fn,i.fn.__self=i.fn.__self__=e.fn.constructor=i,i},e},N=D({__lego:function(){var t=d(this);i({on:"bind",off:"unbind",fire:"triggerHandler"},function(e,i){this[i]=function(){return t[e].apply(t,arguments),this}},this)},emit:function(t,e){var i,n=("on-"+t).replace(/-(.)/g,function(t,e){return e.toUpperCase()}),s=d.Event(t.replace(/-/g,""));return s.target=this,(this[n]===p||this[n].apply(this,[s].concat(e))!==!1)&&(s.isImmediatePropagationStopped()||(i=this.fire(s,e))),i}}),E=N.extend({__lego:function(e){if(N.fn.__lego.call(this),this.options=e=n({el:null,selector:"a[href],[data-nav]",basePath:"/",production:t.Pilot&&t.Pilot.production,useHistory:!1},e),this.items=[],this.itemsIdx={},this.request=this.referrer=E.parseURL(E.getLocation()),this.history=[],this.historyIdx=0,e.useHistory&&d(t).bind("popstate hashchange",w(this,function(){this.nav(E.getLocation())})),e.profile){r(this,"emit",!0),i({prepare:"_getUnits","load data":"_loadUnits","do routes":"_doRouteUnits"},function(t,e){r(this,t,0,0,e)},this);var s=this.nav;this.nav=function(){var t=this,e=t._profilerTimers=[],i=function(){$(t,"Pilot"),t.emit("profile",[e]),o(t.request.path,e)};return P(t,"Pilot"),s.apply(t,arguments).then(i,i)}}e.el&&d(e.el).delegate(e.selector,"click",w(this,function(t){this.nav(E.getLocation(t.currentTarget.getAttribute("data-nav")||t.currentTarget.getAttribute("href"))),t.preventDefault()})),this.init()},init:function(){},route:function(t,e,i,n,s){var r=this.addRoute(t,e,i,n,s);return s?r:this},addRoute:function(t,e,i,s,r){if(/string|regexp/i.test(b.call(e))||(s=i,i=e,e=t,t=p),i&&!i.fn){var o=i;i=j.extend("function"!=typeof o?o:{init:function(){this.on("routestart routechange"+(s===!0?" routeend":""),o)}})}"regexp"!==d.type(e)&&(e=(this.options.basePath+("."==e?"":e)).replace(/\/\//,"/"));var u,h=[],l=this,c=s&&s.paramsRules||i&&i.fn.paramsRules||{};return r&&(l=new E({basePath:e,paramsRules:c}),l.items=this.items,l.itemsIdx=this.itemsIdx,l.parentRouter=this,e+="*"),i&&(u=this.items.push({id:t,path:e,keys:h,regexp:a(e,h,n({},l.options.paramsRules,c)),unit:i||E.View,options:s}),t&&(this.itemsIdx[t]=u-1)),r?l:u},removeRoute:function(t){t=this.itemsIdx[t]||t,this.items.splice(t,1)},createGroup:function(t,e,i,n){return this.route(t,e,i,n,!0)},closeGroup:function(){return this.parentRouter||this},_getUnits:function(t,e){var s=[];return i(e,function(e){var i=e.unit,r=[];u(t,e.regexp,e.keys,r)&&(i.__self===p&&(e.unit=i=new i(n({id:e.id,router:this,inited:!1},e.options))),i.requestParams=r,s.push(i))},this),s},_loadUnits:function(t,e){var n,s,r,o,a,u,l=[],c=[],f=this.options.production,p=function(t,e){t.__self||(t=new t({router:this.router,inited:!1,parentRoute:this,subrouteName:e}),t.el=t.el||'[data-subview-id="'+e+'"]',this.subroutes[e]=t),t.requestParams=this.requestParams,a.push(t)};for(a=e.concat();n=a.shift();)if(n&&n.isActive(e)){if(t.params=n.requestParams,s=null,h(n,null),r=U(n,t),o=n.accessDeniedRedirectTo&&{redirectTo:n.accessDeniedRedirectTo,redirectParams:n.requestParams},!r)return n.emit("access-denied",t),g().reject(o);if(r.then&&(r.denied=o,c.push(r)),i(n.subroutes,p,n),n.loadData)if(r&&r.then)s=w(n,"loadData",t,this._navByHistory);else if(f)try{s=n.loadData(t,this._navByHistory)}catch(d){s=g().reject(d),d.name="loadData",this.emit("error",d,t)}else s=n.loadData(t,this._navByHistory);s&&(s.fail&&s.fail(w(null,h,n)),l.push(s)),delete t.params}return c.length?(u=g(),q(c).then(function(){q(l).then(u.resolve,u.reject)},function(){u.reject(r.denied)})):u=q(l),u.promise()},_doRouteUnits:function(t,e){var n=this.options,s=n.profile,r=n.production,o=w(this,function(t,e,i){if(r)try{t.emit(e,i)}catch(n){n.name=e.replace("-",""),this.emit("error",n,i),h(t,n)}else t.emit(e,i)});i(e,function(e){var i=e.unit,n=!0,r=[],a=t.clone();s&&i.__self&&P(this,"#"+i.getRouteName()),a.params=r,u(a,e.regexp,e.keys,r)&&i.isActive(this.activeUnits)?(i.request=a,i.inited!==!0&&i.__init(),i.active!==!0&&(n=!1,i.active=!0,o(i,"route-start",a)),o(i,"route",a),n&&o(i,"route-change",a)):i.active!==!0||~d.inArray(i,this.activeUnits)||(i.active=!1,i.request=a,o(i,"route-end",a)),s&&i.__self&&$(this,"#"+i.getRouteName())},this)},_doRouteDone:function(t){if(this.activeRequest===t){this.request.url!=t.url&&(this.referrer=this.request,this.options.useHistory&&E.setLocation(t)),this.request=t,this._navByHistory||(this.history=this.history.slice(0,this.historyIdx+1),this.historyIdx=this.history.push(t.url)-1),this.items.length&&this._doRouteUnits(t,this.items);var e=new Date-this.__ts;this.emit("route",[t,e]),this.emit("routeend",[t,e]),this.options.profile||this.log("Pilot.nav: "+e+"ms ("+t.path+t.search+")")}},_doRouteFail:function(t,e){if(e=e||{},this.activeRequest===t){var i=e.redirectTo;this.activeRequest=null,this.emit("route-fail",t,e),i&&(".."===i?(i=t.path.split("/"),""===i.pop()&&(i.pop(),i.push("")),i=i.join("/")):"function"==typeof i?i=i.call(this,t):this.get(i)&&(i=this.getUrl(i,e.redirectParams)),this.nav(i))}},log:function(e){!this.options.production&&t.console&&console.log(e)},error:function(e){this.options.production||(t.console&&console.error?console.error(e):this.log(e))},getFailRoutes:function(){return d(this.activeUnits).filter(function(t,e){return!!e.getRouteError()}).get()},get:function(t){var e=this.getItem(t);return e&&e.unit},getItem:function(t){return this.items[this.itemsIdx[t]]},getUrl:function(t,e,i){var s,r,o=this.getItem(t),a=0;return o&&(e=n({},e,i),s=o.keys,r=o.path.replace(/:(\w+)\??(\/?)/g,function(t,i,n,r){return i=s[a++],r=i&&e[i.name],r?r+(n||""):"("+t+")"}).replace(/\(.*?:[^)]+\)+\??/g,"").replace(/\(|\)\??/g,"").replace(/\/+/g,"/")),r},start:function(t){this.started||this._nav(t||this.request,!1,!0)},_nav:function(t,e,i){var n=g(),s=E.parseURL(t.href||t.url||t);if(this.started=!0,this._navByHistory=!!e,i||!this.activeRequest||this.activeRequest.url!=s.url){this.__ts=+new Date,this.emit("before-route",[s,this.__ts]);var r=this._getUnits(s,this.items);s.referrer=this.request.url,this.activeUnits=r,this.activeRequest=s,r.length?this._loadUnits(s,r).done(w(this,this._doRouteDone,s)).fail(w(this,this._doRouteFail,s)).then(n.resolve,n.reject):(this._doRouteDone(s),this.emit("404",s),n.reject())}else n.resolve();return n.promise()},nav:function(t,e,i){return d.isFunction(e)&&(i=e,e=!1),this._nav(t,!1,e).then(i,i)},go:function(t,e){var i=this.getUrl(t,e);return i?this.nav(i):g().reject().promise()},hasBack:function(){return this.historyIdx>0},hasForward:function(){return!!this.history[this.historyIdx+1]},back:function(){return this.hasBack()?this._nav(this.history[--this.historyIdx],!0):g().resolve()},forward:function(){return this.hasForward()?this._nav(this.history[++this.historyIdx],!0):g().resolve()}});E.parseURL=function(t){return new e(t)},e.fn=e.prototype={constructor:e,clone:function(){return new e(this.url)},toString:function(){return this.url}},E.setLocation=function(t){E.pushState&&m.pushState?m.pushState(null,v.title,t.url):_.hash="#!"+t.path+t.search},E.getLocation=function(t){return t=t||""+_,E.pushState||(t=t.split(/#!?/).pop()),E.parseURL(t).path};var j=N.extend({data:{},boundAll:[],paramsRules:{},subroutes:null,__lego:function(t){N.fn.__lego.call(this),n(this,t),this.subroutes=this.subroutes||this.subviews,i(this.boundAll,function(t){this[t]=this.bound(t)},this),this.router&&this.router.options.profile&&i({init:0,loadData:0,render:0,emit:1},function(t,e){r(this,e,t,1)},this),this.on("routestart route routechange routeend",this.bound(function(t,e){var n=t.type.substr(5);n=n?"route-"+n:"route",i(this.subroutes,function(t){t.emit(n,e)})})),this.inited!==!1&&this.__init()},__init:function(){this.inited=!0,this.emit("beforeInit"),this.init(),this.emit("init")},_exception:function(t,e){throw"["+this.uniqId+"."+t+"]: "+e},isActive:function(){return!0},bound:function(t){return"string"==typeof t&&(this[t]===p&&this._exception("bound",t+" -- method not found"),t=this[t]),w(this,t)},getRouteError:function(){return this._routeError},init:f,loadData:f,destroy:f,getUrl:function(t,e,i){return"string"!=typeof t&&(i=e,e=t,t=this.id),this.router.getUrl(t,e,i)},setData:function(t,e){return e?n(this.data,t):this.data=t,this},getData:function(){return this.data},getRouteName:function(){return(this.parentRoute?this.parentRoute.getRouteName()+".":"")+(this.id||this.subrouteName||this.uniqId)}}),A=j.extend({el:null,$el:d(),tag:null,tagName:null,className:"",parentNode:null,template:null,events:{},__init:function(){if(this.inited=!0,this.__init=f,this.el)this.setElement(d(this.el,this.parentNode));else if(this.tagName||this.tag){var t=this.tagName,e=this.parentNode,n=this.className;this.tag&&(t=this.tag.match(/^(#[^\s]+)?\s*([^\.]+)\.?([^$]+)?/),t[1]&&(e=t[1]),t[3]&&(n=t[3].split(".").join(" ")),t=t[2]),this.el=v.createElement(t),this.$el=d(this.el),n&&this.$el.addClass(n),e&&(d.isReady?this.$el.appendTo(e):d(this.bound(function(){this.$el.appendTo(e)})))}else this.$el[0]=p,this.$el.length=0;this.on("routestart.view routeend.view",this.bound(function(t){this._toggleView("routeend"!=t.type)})),j.fn.__init.call(this),i(this.subroutes,function(t){t.parentNode=this.el,t.__init()},this)},_toggleView:function(t){this.$el&&this.$el.css("display",t?"":"none")},setElement:function(t){return this.undelegateEvents(),t?(this.$el=d(t),this.delegateEvents()):(this.$el[0]=p,this.$el.length=0),this.el=this.$el[0],this},delegateEvents:function(t){return this.undelegateEvents(),i(t||this.events,function(t,e){e=e.match(/^([^\s]+)\s+(.+)/),this.$el.delegate(e[2],e[1]+".delegateEvents"+this.cid,this.bound(t))},this),this},undelegateEvents:function(){return this.$el&&this.$el.unbind(".delegateEvents"+this.cid),this},$:function(t){var e=this.$el;return void 0!==t&&(e="string"==typeof t?e.find(t):d(t)),e},getHtml:function(t){return t=t?n({},this.getData(),t):this.getData(),this.template(t)},render:function(){var t=this.getHtml();"string"==typeof t&&(this.emit("before-render"),this.$el.empty().each(function(){this.innerHTML=t}),this.emit("render"))}});E.utils={each:i,extend:n,qs:{parse:s,stringify:d.param}},E.access={extend:function(t){n(this,t)}},E.Route=j,E.View=A,E.Class=D,E.Emitter=N,E.Request=e,E.version="1.3.0",t.Pilot=E,"function"==typeof define&&define.amd?define("Pilot",[],function(){return E}):t.ajs&&ajs.loaded&&ajs.loaded("{pilot}Pilot")})("undefined"!=typeof module&&module.exports||window);